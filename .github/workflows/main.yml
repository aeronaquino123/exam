name: Convert and Deploy Modified Sigma Rules

on:
  push:
    paths:
      - "rules/**.yml"
  pull_request:
    paths:
      - "rules/**.yml"
  # Manual trigger
  workflow_dispatch:

jobs:
  # Step 1: Validate Sigma rules
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Need to fetch more than one commit to compare changes
        
      - name: Validate Sigma rules
        uses: SigmaHQ/sigma-rules-validator@v1
        with:
          paths: |-
            ./rules
          schemaFile: ${{ github.workspace }}/sigma-schema.json

  # Step 2: Convert and deploy only changed rules
  convert-and-deploy:
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Need to fetch more than one commit to compare changes
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sigma-cli requests
          sigma plugin install splunk
      
      - name: Find Changed Files
        id: changed-files
        run: |
          # Get the list of modified or added .yml files in the rules directory from the latest commit
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- rules/ | grep "\.yml$" || echo "")
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
      
      - name: Convert and Deploy Changed Sigma Rules
        run: |
          # If no files were changed, exit with success
          if [ -z "${{ steps.changed-files.outputs.changed_files }}" ]; then
            echo "No Sigma rules were modified in this commit."
            exit 0
          fi
          
          # Process each changed Sigma rule
          success_count=0
          failure_count=0
          
          for file in ${{ steps.changed-files.outputs.changed_files }}; do
            rule_name=$(basename "$file" .yml)
            echo "------------------------------------"
            echo "Processing $file (rule: $rule_name)"
            
            # Convert the rule to SPL
            echo "Converting to Splunk SPL..."
            spl_query=$(sigma convert -t splunk -f default "$file" --without-pipeline)
            
            if [ -z "$spl_query" ]; then
              echo "× ERROR: Empty SPL query generated for $file"
              failure_count=$((failure_count + 1))
              continue
            fi
            
            echo "✓ SPL query generated successfully"
            
            # Deploy the rule directly to Splunk
            echo "Deploying to Splunk..."
            python scripts/deploy_to_splunk.py \
              --url "$SPLUNK_URL" \
              --token "$SPLUNK_TOKEN" \
              --rule "$rule_name" \
              --query "$spl_query" \
              --actions "log"
            
            deploy_status=$?
            if [ $deploy_status -eq 0 ]; then
              echo "✓ Rule deployed successfully to Splunk"
              success_count=$((success_count + 1))
            else
              echo "× ERROR: Failed to deploy rule to Splunk"
              failure_count=$((failure_count + 1))
            fi
            
            echo "------------------------------------"
          done
          
          echo "Conversion and deployment complete:"
          echo "Success: $success_count rules"
          echo "Failures: $failure_count rules"
          
          # Always exit with success
          exit 0
        shell: bash
        env:
          SPLUNK_URL: ${{ secrets.SPLUNK_URL }}
          SPLUNK_TOKEN: ${{ secrets.SPLUNK_API_TOKEN }}
